<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GEOFINDERS - Battle Royale GPS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS & JS (Mapas) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            overflow: hidden;
            touch-action: none;
        }
        .font-military {
            font-family: 'Black Ops One', cursive;
        }
        #map {
            height: 100vh;
            width: 100vw;
            z-index: 0;
            background: #1a1a1a;
        }
        /* UI Layers */
        .ui-layer {
            position: absolute;
            z-index: 1000;
            pointer-events: none;
        }
        .interactive {
            pointer-events: auto;
        }
        
        /* Scope Overlay */
        .scope-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid rgba(0, 255, 0, 0.3);
            border-radius: 50%;
            pointer-events: none;
            z-index: 900;
            display: none;
        }
        .scope-crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ff00;
            font-size: 24px;
        }

        /* Compass */
        .compass-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: rgba(0,0,0,0.8);
            overflow: hidden;
            z-index: 1001;
            display: none;
        }
        .compass-strip {
            width: 200%;
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                transparent 0px,
                transparent 19px,
                #00ff00 20px
            );
            position: absolute;
            transition: transform 0.1s linear;
        }
        .compass-marker {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: red;
            z-index: 1002;
        }

        /* Animations */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        .damage-effect {
            animation: pulse-red 1s infinite;
        }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.95);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .tab-active {
            background-color: #16a34a; /* green-600 */
            border-color: #22c55e; /* green-500 */
            color: white;
        }
        .tab-inactive {
            background-color: #334155; /* slate-700 */
            border-color: #475569; /* slate-600 */
            color: #94a3b8; /* gray-400 */
        }
    </style>
</head>
<body>

    <div id="app" class="relative w-full h-full">

        <!-- SCREEN: LOBBY -->
        <div id="lobby-screen" class="modal-backdrop z-50 flex flex-col gap-4 overflow-y-auto">
            <h1 class="text-5xl text-green-500 font-military tracking-widest text-center mb-2 mt-10">GEOFINDERS</h1>
            
            <div class="w-full max-w-sm bg-slate-900 p-6 rounded-xl border border-slate-700 shadow-2xl relative">
                
                <!-- ID Display -->
                <div class="absolute top-2 right-4 text-[10px] text-gray-600 font-mono">
                    ID: <span id="display-userid">...</span>
                </div>

                <!-- Step 1: Identity -->
                <div id="step-identity" class="flex flex-col gap-4">
                    <div class="text-center">
                        <label class="block text-gray-400 text-sm mb-1">IDENTIFICACIÓN DE SOLDADO</label>
                        <input type="text" id="username-input" class="w-full bg-slate-800 border-2 border-slate-600 p-3 rounded text-white text-center font-bold text-lg focus:border-green-500 focus:outline-none uppercase" placeholder="TU NOMBRE">
                    </div>
                    <button id="btn-set-identity" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded shadow-[0_0_15px_rgba(34,197,94,0.4)] transition">
                        CONFIRMAR IDENTIDAD
                    </button>
                </div>

                <!-- Step 2: Action Selection (Create/Join) -->
                <div id="step-action" class="hidden flex flex-col gap-4">
                    <p class="text-center text-gray-300">Bienvenido, <span id="welcome-name" class="font-bold text-green-400"></span></p>
                    
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <button onclick="switchTab('create')" id="tab-create" class="tab-inactive py-3 rounded font-bold transition">CREAR SALA</button>
                        <button onclick="switchTab('join')" id="tab-join" class="tab-inactive py-3 rounded font-bold transition">UNIRSE</button>
                    </div>

                    <!-- CREATE PANEL -->
                    <div id="panel-create" class="hidden flex flex-col gap-3 animate-fade-in">
                        <div class="bg-slate-800 p-3 rounded text-xs text-gray-400 border border-slate-700">
                            <i class="fas fa-info-circle text-blue-400"></i> Como <b>Anfitrión</b>, tu ubicación actual será el CENTRO de la zona segura.
                        </div>
                        <div class="flex gap-2">
                             <button class="mode-btn flex-1 py-2 bg-slate-700 rounded border border-slate-600 text-gray-300" onclick="setMode('SOLO')">SOLO</button>
                             <button class="mode-btn flex-1 py-2 bg-slate-700 rounded border border-slate-600 text-gray-300" onclick="setMode('DUO')">DUO</button>
                        </div>
                        <button id="btn-create-game" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded mt-2 shadow-lg">
                            <i class="fas fa-satellite-dish mr-2"></i> ESTABLECER ZONA Y CREAR
                        </button>
                        <p id="creating-status" class="text-xs text-center text-yellow-500 hidden animate-pulse">Obteniendo coordenadas GPS de alta precisión...</p>
                    </div>

                    <!-- JOIN PANEL -->
                    <div id="panel-join" class="hidden flex flex-col gap-3 animate-fade-in">
                        <label class="text-xs text-gray-400">CÓDIGO DE SALA (4 LETRAS)</label>
                        <input type="text" id="join-code-input" class="bg-slate-800 border-2 border-slate-600 p-4 rounded text-white text-center font-mono text-2xl tracking-[0.5em] focus:border-blue-500 focus:outline-none uppercase" placeholder="ABCD" maxlength="4">
                        
                        <div id="duo-join-inputs" class="hidden">
                             <label class="text-xs text-gray-400 mt-2">ID DE EQUIPO</label>
                             <input type="text" id="join-team-input" class="w-full bg-slate-800 border border-slate-600 p-2 rounded text-white uppercase" placeholder="NOMBRE EQUIPO">
                        </div>

                        <button id="btn-join-game" class="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-4 rounded mt-2 shadow-lg">
                            <i class="fas fa-sign-in-alt mr-2"></i> UNIRSE A LA OPERACIÓN
                        </button>
                    </div>
                </div>

                <!-- Step 3: Waiting Room (Host Only mainly) -->
                <div id="step-waiting" class="hidden flex-col items-center gap-4 text-center">
                    <div class="bg-slate-800 p-6 rounded-full border-4 border-green-500 animate-pulse shadow-[0_0_30px_rgba(34,197,94,0.3)]">
                        <span id="generated-code" class="text-4xl font-mono font-bold text-white tracking-widest">----</span>
                    </div>
                    <p class="text-gray-400 text-sm">Comparte este código con tus amigos.</p>
                    <div class="text-xs text-gray-500 mt-2">Esperando jugadores...</div>
                    <button id="btn-start-match" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded mt-4 shadow-lg hidden">
                        INICIAR PARTIDA AHORA
                    </button>
                </div>

            </div>
            
            <div class="text-[10px] text-gray-500 text-center max-w-xs mt-4">
                ⚠️ El GPS funciona mejor al aire libre. Asegúrate de tener batería.
            </div>
        </div>

        <!-- SCREEN: HUD -->
        <div id="hud-layer" class="ui-layer w-full h-full hidden">
            <!-- Compass -->
            <div class="compass-container flex" id="compass-ui">
                <div class="compass-marker"></div>
                <div class="compass-strip" id="compass-strip"></div>
                <div class="absolute top-8 left-1/2 transform -translate-x-1/2 text-xs font-mono text-green-500" id="heading-display">0°</div>
            </div>

            <!-- Top Info -->
            <div class="absolute top-12 left-0 w-full p-2 flex justify-between items-start pointer-events-none">
                <div class="bg-black/60 backdrop-blur p-2 rounded border-l-4 border-blue-500">
                    <div class="text-[10px] text-gray-300">SALA: <span id="hud-room-code" class="text-white font-bold"></span></div>
                    <div class="font-bold text-blue-400 text-sm" id="game-status-text">ESPERANDO...</div>
                </div>
                <div class="bg-black/60 backdrop-blur p-2 rounded flex flex-col items-end">
                    <div class="text-2xl font-military text-white" id="alive-count">1</div>
                    <div class="text-[10px] text-gray-400">JUGADORES</div>
                </div>
            </div>

            <!-- Alerts -->
            <div id="alert-box" class="absolute top-28 left-1/2 transform -translate-x-1/2 bg-red-600/90 text-white px-6 py-3 rounded font-bold text-center hidden shadow-lg animate-pulse z-50 pointer-events-none w-3/4">
                ⚠️ FUERA DE LA ZONA SEGURA<br><span class="text-xs font-normal">Regresa al círculo o morirás.</span>
            </div>

            <div id="waiting-msg" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-green-400 px-6 py-4 rounded-xl text-center border border-green-500 pointer-events-none">
                <h3 class="font-bold text-lg">SINCRONIZANDO</h3>
                <p class="text-xs text-white">Esperando que el anfitrión inicie...</p>
            </div>

            <!-- Scope -->
            <div id="scope" class="scope-overlay">
                <div class="scope-crosshair">+</div>
            </div>

            <!-- Bottom Controls -->
            <div class="absolute bottom-0 left-0 w-full p-4 pb-8 flex flex-col gap-3 pointer-events-none">
                
                <!-- Health -->
                <div class="flex items-end gap-2">
                    <div class="bg-black/80 p-3 rounded-lg flex-1 border border-gray-700 backdrop-blur-sm">
                        <div class="flex justify-between text-xs mb-1 font-bold">
                            <span class="text-gray-300">SALUD</span>
                            <span class="text-green-400" id="hp-text">100%</span>
                        </div>
                        <div class="w-full bg-gray-800 h-3 rounded-full overflow-hidden border border-gray-600">
                            <div id="hp-bar" class="bg-green-500 h-full w-full transition-all duration-300"></div>
                        </div>
                        <div id="duo-status" class="text-[10px] text-orange-400 mt-2 hidden font-bold text-center bg-orange-900/30 rounded p-1">
                            PAREJA A: <span id="partner-dist">--</span>m
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex justify-between items-center pointer-events-auto px-2">
                    <button id="btn-sos" class="bg-red-900/80 hover:bg-red-800 text-white h-14 w-14 rounded-full border-2 border-red-500 font-bold text-[10px] shadow-lg flex flex-col items-center justify-center">
                        <span>SOS</span>
                    </button>

                    <button id="btn-shoot" class="bg-yellow-600 hover:bg-yellow-500 active:scale-95 transition text-black h-20 w-20 rounded-full border-4 border-yellow-300 shadow-[0_0_20px_rgba(234,179,8,0.5)] flex items-center justify-center z-50">
                        <i class="fa-solid fa-crosshairs text-3xl"></i>
                    </button>
                    
                    <button id="btn-center" class="bg-slate-700/80 hover:bg-slate-600 text-white h-14 w-14 rounded-full border border-slate-500 shadow-lg flex items-center justify-center">
                        <i class="fa-solid fa-location-arrow"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Map Container -->
        <div id="map"></div>

        <!-- Dead Screen -->
        <div id="dead-screen" class="modal-backdrop hidden flex-col text-center z-[3000]">
            <i class="fa-solid fa-skull-crossbones text-6xl text-red-600 mb-4 animate-bounce"></i>
            <h2 class="text-5xl text-red-600 font-military mb-2">ELIMINADO</h2>
            <p class="text-gray-300 mb-8 max-w-xs mx-auto">Has caído en combate. Tu posición ha sido marcada.</p>
            <button onclick="location.reload()" class="bg-slate-700 hover:bg-slate-600 border border-slate-500 px-8 py-3 rounded text-white font-bold">VOLVER AL MENÚ</button>
        </div>

    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBMYTnk-CljdWENtDQqqKUBmQzBQuoxYPo",
            authDomain: "hello-74404.firebaseapp.com",
            databaseURL: "https://hello-74404-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hello-74404",
            storageBucket: "hello-74404.firebasestorage.app",
            messagingSenderId: "781363507648",
            appId: "1:781363507648:web:5c7b871f11b9010bfd1825"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = "geofinders-v1"; // Namespace

        // STATE
        const state = {
            userId: null,
            username: "Soldado",
            gameId: null,
            isHost: false,
            mode: 'SOLO',
            teamId: null, // For Duo
            lat: null,
            lng: null,
            accuracy: 0,
            heading: 0,
            hp: 100,
            isDead: false,
            gameStatus: 'WAITING', // WAITING, PLAYING
            stormCenter: null, // {lat, lng}
            stormRadius: 300, // Starts big (300m)
            map: null,
            markers: {},
            userMarker: null,
            stormCircleLayer: null
        };

        // --- 1. IDENTITY & INIT ---
        
        function getOrGenerateUserId() {
            let id = localStorage.getItem('gf_uid');
            if (!id) {
                id = 'user_' + Math.random().toString(36).substr(2, 6).toUpperCase();
                localStorage.setItem('gf_uid', id);
            }
            return id;
        }

        function init() {
            state.userId = getOrGenerateUserId();
            document.getElementById('display-userid').innerText = state.userId;
            
            const savedName = localStorage.getItem('gf_name');
            if(savedName) document.getElementById('username-input').value = savedName;

            // Setup UI Events
            document.getElementById('btn-set-identity').onclick = confirmIdentity;
            document.getElementById('btn-create-game').onclick = createGame;
            document.getElementById('btn-join-game').onclick = joinGame;
            document.getElementById('btn-start-match').onclick = hostStartGame;
            
            // Map
            initMap();
        }

        function confirmIdentity() {
            const name = document.getElementById('username-input').value.trim();
            if(!name) return alert("Nombre obligatorio");
            
            state.username = name;
            localStorage.setItem('gf_name', name);
            
            document.getElementById('step-identity').classList.add('hidden');
            document.getElementById('step-action').classList.remove('hidden');
            document.getElementById('step-action').classList.add('flex');
            document.getElementById('welcome-name').innerText = name;
            
            // Default tab
            switchTab('join');
            
            // Start GPS now to warm up
            startSensors(); 
        }

        window.switchTab = (tab) => {
            const btnCreate = document.getElementById('tab-create');
            const btnJoin = document.getElementById('tab-join');
            const panelCreate = document.getElementById('panel-create');
            const panelJoin = document.getElementById('panel-join');

            if(tab === 'create') {
                btnCreate.className = "tab-active flex-1 py-3 rounded font-bold transition";
                btnJoin.className = "tab-inactive flex-1 py-3 rounded font-bold transition";
                panelCreate.classList.remove('hidden');
                panelJoin.classList.add('hidden');
            } else {
                btnCreate.className = "tab-inactive flex-1 py-3 rounded font-bold transition";
                btnJoin.className = "tab-active flex-1 py-3 rounded font-bold transition";
                panelCreate.classList.add('hidden');
                panelJoin.classList.remove('hidden');
            }
        };

        window.setMode = (m) => {
            state.mode = m;
            document.querySelectorAll('.mode-btn').forEach(b => {
                if(b.innerText === m) {
                    b.classList.remove('bg-slate-700', 'text-gray-300');
                    b.classList.add('bg-blue-600', 'text-white', 'border-blue-400');
                } else {
                    b.classList.add('bg-slate-700', 'text-gray-300');
                    b.classList.remove('bg-blue-600', 'text-white', 'border-blue-400');
                }
            });
        };

        // --- 2. GAME LOBBY LOGIC ---

        async function createGame() {
            if(!state.lat) {
                document.getElementById('creating-status').classList.remove('hidden');
                alert("Esperando señal GPS precisa para establecer la base... Muévete un poco.");
                return;
            }

            // Generate 4 letter code
            const code = Math.random().toString(36).substring(2, 6).toUpperCase();
            state.gameId = code;
            state.isHost = true;
            state.teamId = state.userId; // Solo host is own team

            // Create Game Doc
            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', `matches/${code}`);
            
            // Set Initial Game State
            // STORM CENTER is HOST location
            await setDoc(gameRef, {
                hostId: state.userId,
                status: 'WAITING', // No damage yet
                mode: state.mode,
                stormCenter: { lat: state.lat, lng: state.lng },
                stormRadius: 300, // 300 meters Safe Zone
                createdAt: serverTimestamp()
            });

            // Join myself
            await joinMyGame(code);

            // UI Update
            document.getElementById('step-action').classList.add('hidden');
            document.getElementById('step-waiting').classList.remove('hidden');
            document.getElementById('step-waiting').classList.add('flex');
            document.getElementById('generated-code').innerText = code;
            document.getElementById('btn-start-match').classList.remove('hidden');
        }

        async function joinGame() {
            const code = document.getElementById('join-code-input').value.toUpperCase();
            if(code.length !== 4) return alert("Código inválido");
            
            // Check if game exists first
            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', `matches/${code}`);
            const snap = await getDoc(gameRef);
            
            if(!snap.exists()) return alert("Partida no encontrada");
            
            const gameData = snap.data();
            state.gameId = code;
            state.isHost = false;
            state.mode = gameData.mode; // Inherit mode
            
            if(state.mode === 'DUO') {
                const team = document.getElementById('join-team-input').value.toUpperCase().trim();
                if(!team) return alert("Introduce ID de Equipo para DUO");
                state.teamId = team;
            } else {
                state.teamId = state.userId;
            }

            await joinMyGame(code);
            enterHUD();
        }

        async function joinMyGame(gameId) {
            // Create/Update Player Doc
            const playerRef = doc(db, 'artifacts', appId, 'public', 'data', `matches/${gameId}/players/${state.userId}`);
            await setDoc(playerRef, {
                username: state.username,
                teamId: state.teamId,
                lat: state.lat || 0,
                lng: state.lng || 0,
                hp: 100,
                isDead: false,
                lastSeen: serverTimestamp()
            });

            // Start Listeners
            subscribeToGame(gameId);
        }

        function hostStartGame() {
            if(!state.isHost) return;
            const gameRef = doc(db, 'artifacts', appId, 'public', 'data', `matches/${state.gameId}`);
            updateDoc(gameRef, { status: 'PLAYING' });
            enterHUD();
        }

        function enterHUD() {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('hud-layer').classList.remove('hidden');
            document.getElementById('compass-ui').classList.remove('hidden');
            document.getElementById('hud-room-code').innerText = state.gameId;
            
            // Force map resize
            setTimeout(() => {
                state.map.invalidateSize();
                if(state.lat) state.map.setView([state.lat, state.lng], 18);
            }, 500);
        }

        // --- 3. FIRESTORE SYNC ---

        function subscribeToGame(gameId) {
            // 1. Subscribe to Game State (Storm, Status)
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', `matches/${gameId}`), (doc) => {
                if(doc.exists()) {
                    const data = doc.data();
                    state.gameStatus = data.status;
                    state.stormCenter = data.stormCenter;
                    state.stormRadius = data.stormRadius;
                    
                    updateGameUI(data);
                    drawStorm();
                }
            });

            // 2. Subscribe to Players
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', `matches/${gameId}/players`), (snapshot) => {
                const alive = snapshot.docs.filter(d => !d.data().isDead).length;
                document.getElementById('alive-count').innerText = alive;

                snapshot.docChanges().forEach(change => {
                    const pid = change.doc.id;
                    const pdata = change.doc.data();

                    if(pid === state.userId) {
                        // My data updated externally? (Damage taken)
                        if(pdata.hp < state.hp) {
                            state.hp = pdata.hp;
                            updateHealthUI();
                            triggerDamageEffect();
                        }
                    } else {
                        // Other players
                        updateEnemyMarker(pid, pdata);
                        if(state.mode === 'DUO' && pdata.teamId === state.teamId) {
                            updateTeammate(pid, pdata);
                        }
                    }
                });
            });
        }

        function updateGameUI(data) {
            const statusText = document.getElementById('game-status-text');
            const waitMsg = document.getElementById('waiting-msg');
            
            if(data.status === 'WAITING') {
                statusText.innerText = "EN ESPERA";
                statusText.classList.remove('text-red-500');
                statusText.classList.add('text-blue-400');
                waitMsg.classList.remove('hidden');
            } else {
                statusText.innerText = "EN CURSO - PELIGRO";
                statusText.classList.remove('text-blue-400');
                statusText.classList.add('text-red-500');
                waitMsg.classList.add('hidden');
                
                // If I was waiting in lobby step-waiting as host, move me
                if(!document.getElementById('step-waiting').classList.contains('hidden')) {
                    enterHUD();
                }
            }
        }

        // --- 4. MAP & SENSORS ---

        function initMap() {
            state.map = L.map('map', { zoomControl: false, attributionControl: false }).setView([0,0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(state.map);
            
            // Marker Icons
            const dot = (col) => L.divIcon({
                className: '',
                html: `<div style="background:${col};width:14px;height:14px;border:2px solid white;border-radius:50%;box-shadow:0 0 10px ${col}"></div>`,
                iconSize: [14, 14], iconAnchor: [7, 7]
            });
            state.icons = {
                me: dot('#22c55e'), // Green
                enemy: dot('#ef4444'), // Red
                team: dot('#3b82f6') // Blue
            };
        }

        function startSensors() {
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(pos => {
                    state.lat = pos.coords.latitude;
                    state.lng = pos.coords.longitude;
                    state.accuracy = pos.coords.accuracy;

                    // Update Map Marker
                    if(!state.userMarker) {
                         state.userMarker = L.marker([state.lat, state.lng], {icon: state.icons.me}).addTo(state.map);
                         state.map.setView([state.lat, state.lng], 18);
                    } else {
                        state.userMarker.setLatLng([state.lat, state.lng]);
                    }

                    // Update Server
                    if(state.gameId && !state.isDead) {
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', `matches/${state.gameId}/players/${state.userId}`);
                        updateDoc(ref, { 
                            lat: state.lat, 
                            lng: state.lng, 
                            heading: state.heading,
                            lastSeen: serverTimestamp() 
                        }).catch(()=>{}); // Ignore rapid update errors
                    }

                    // Check Storm
                    checkStormDamage();

                }, err => console.error(err), { enableHighAccuracy: true, maximumAge: 0 });
            }

            // Compass
            const handleOrientation = (e) => {
                let heading = e.webkitCompassHeading || e.alpha;
                if(!heading) return;
                // Fix Android absolute
                if(!e.webkitCompassHeading) heading = 360 - heading; 
                
                state.heading = heading;
                document.getElementById('heading-display').innerText = Math.round(heading) + "°";
                
                // Strip logic (simplified)
                // Just shift background position? Or translate?
                // Visual only for now
            };

            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleOrientation);
            }
        }

        function drawStorm() {
            if(!state.stormCenter) return;

            if(state.stormCircleLayer) state.map.removeLayer(state.stormCircleLayer);

            // Draw Safe Zone (Green/Blue/Clear) inside Red Zone?
            // Usually games draw the Safe Zone circle.
            // Let's draw a Red Circle for the boundary
            
            state.stormCircleLayer = L.circle([state.stormCenter.lat, state.stormCenter.lng], {
                color: '#ef4444', // Red border
                fillColor: '#ef4444', 
                fillOpacity: 0.05,
                weight: 2,
                radius: state.stormRadius // Meters
            }).addTo(state.map);
        }

        function checkStormDamage() {
            if(state.gameStatus !== 'PLAYING' || !state.stormCenter || state.isDead) return;

            const dist = getDist(state.lat, state.lng, state.stormCenter.lat, state.stormCenter.lng);
            
            if(dist > state.stormRadius) {
                // OUTSIDE!
                document.getElementById('alert-box').classList.remove('hidden');
                
                // Damage tick (approx every 3s via simple timestamp check or random chance per update)
                // Better: Check time. Using random for simplicity in client-only loop
                if(Math.random() < 0.05) { // roughly once per 20 gps updates (if 1hz) -> very slow.
                    // Let's rely on setInterval for damage
                }
            } else {
                document.getElementById('alert-box').classList.add('hidden');
            }
        }
        
        // Damage Loop (Running separately)
        setInterval(() => {
             if(state.gameStatus === 'PLAYING' && state.stormCenter && !state.isDead && state.lat) {
                 const dist = getDist(state.lat, state.lng, state.stormCenter.lat, state.stormCenter.lng);
                 if(dist > state.stormRadius) {
                     takeDamage(5); // 5 DMG every second
                 }
             }
        }, 1000);

        function takeDamage(amount) {
            state.hp = Math.max(0, state.hp - amount);
            updateHealthUI();
            triggerDamageEffect();
            
            // Sync
            const ref = doc(db, 'artifacts', appId, 'public', 'data', `matches/${state.gameId}/players/${state.userId}`);
            updateDoc(ref, { hp: state.hp });

            if(state.hp <= 0) {
                state.isDead = true;
                updateDoc(ref, { isDead: true });
                document.getElementById('dead-screen').classList.remove('hidden');
            }
        }

        // --- 5. OTHERS (Markers, Combat) ---

        function updateEnemyMarker(pid, data) {
            if(data.isDead) {
                if(state.markers[pid]) state.markers[pid].remove();
                return;
            }

            // Visibility Logic: Only if close OR game logic says so.
            // For now: Always visible if < 500m to make it playable
            const dist = getDist(state.lat, state.lng, data.lat, data.lng);
            if(dist < 500) {
                 if(!state.markers[pid]) {
                     state.markers[pid] = L.marker([data.lat, data.lng], {icon: state.icons.enemy}).addTo(state.map)
                        .bindPopup(`<b class="text-red-500">${data.username}</b>`);
                 } else {
                     state.markers[pid].setLatLng([data.lat, data.lng]);
                 }
            }
        }
        
        function updateTeammate(pid, data) {
             const dist = getDist(state.lat, state.lng, data.lat, data.lng);
             document.getElementById('duo-status').classList.remove('hidden');
             document.getElementById('partner-dist').innerText = Math.round(dist);
             
             if(dist > 20) {
                 document.getElementById('duo-status').classList.add('text-red-400');
                 document.getElementById('duo-status').innerHTML = `⚠️ MUY LEJOS: ${Math.round(dist)}m`;
             } else {
                 document.getElementById('duo-status').classList.remove('text-red-400');
                 document.getElementById('duo-status').innerHTML = `PAREJA: ${Math.round(dist)}m`;
             }
        }

        // SHOOTING
        document.getElementById('btn-shoot').addEventListener('click', async () => {
            if(state.isDead || state.gameStatus !== 'PLAYING') return;
            
            // Visual feedback
            const btn = document.getElementById('btn-shoot');
            btn.classList.add('scale-90', 'bg-red-500');
            setTimeout(() => btn.classList.remove('scale-90', 'bg-red-500'), 100);

            // Logic: Scan enemies in markers list
            // Range: 40m, Cone: 15 degrees
            const RANGE = 40; 
            const CONE = 15;
            
            // We iterate Firestore collection via state.markers isn't enough (might not have logic data)
            // But for prototype, we rely on markers existing or we need a local cache of enemy data.
            // Let's assume we hit whoever is in `state.markers`
            
            // Actually, we need to read 'matches/{id}/players' snapshot data.
            // Since we didn't cache full player data in a global list (only markers), let's quick-fetch or use marker positions.
            // Better: Markers are visual. Let's rely on visual hit for simplicity.
            
            // To do it right: fetch collection once (expensive) or cache in `subscribeToGame`.
            // Let's assume we hit a random nearby enemy for the "Feel". 
            // REAL LOGIC:
            // Calculate distance & bearing to all markers.
            let hitId = null;
            
            Object.keys(state.markers).forEach(pid => {
                const m = state.markers[pid];
                const mLat = m.getLatLng().lat;
                const mLng = m.getLatLng().lng;
                
                const d = getDist(state.lat, state.lng, mLat, mLng);
                if(d < RANGE) {
                    const bearing = getBearing(state.lat, state.lng, mLat, mLng);
                    let diff = Math.abs(bearing - state.heading);
                    if(diff > 180) diff = 360 - diff;
                    
                    if(diff < CONE) hitId = pid;
                }
            });

            if(hitId) {
                alert("¡IMPACTO!");
                // Apply dmg to them directly (Prototype Hack)
                const targetRef = doc(db, 'artifacts', appId, 'public', 'data', `matches/${state.gameId}/players/${hitId}`);
                const snap = await getDoc(targetRef);
                if(snap.exists()) {
                    updateDoc(targetRef, { hp: Math.max(0, snap.data().hp - 20) });
                }
            }
        });

        // Utils
        function getDist(lat1, lon1, lat2, lon2) {
            if(!lat1 || !lat2) return 99999;
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function getBearing(startLat, startLng, destLat, destLng) {
            startLat = startLat * Math.PI/180;
            startLng = startLng * Math.PI/180;
            destLat = destLat * Math.PI/180;
            destLng = destLng * Math.PI/180;
            const y = Math.sin(destLng - startLng) * Math.cos(destLat);
            const x = Math.cos(startLat) * Math.sin(destLat) - Math.sin(startLat) * Math.cos(destLat) * Math.cos(destLng - startLng);
            let brng = Math.atan2(y, x);
            return (brng * 180 / Math.PI + 360) % 360;
        }

        function updateHealthUI() {
            const bar = document.getElementById('hp-bar');
            bar.style.width = state.hp + '%';
            document.getElementById('hp-text').innerText = state.hp + '%';
            if(state.hp < 30) {
                bar.classList.remove('bg-green-500');
                bar.classList.add('bg-red-600');
            }
        }

        function triggerDamageEffect() {
            document.body.classList.add('damage-effect');
            setTimeout(() => document.body.classList.remove('damage-effect'), 500);
            if("vibrate" in navigator) navigator.vibrate(200);
        }

        document.getElementById('btn-center').onclick = () => {
             if(state.map && state.lat) state.map.setView([state.lat, state.lng], 18);
        };
        
        document.getElementById('btn-sos').onclick = () => {
             if(confirm("¿RENDIRSE Y SALIR?")) {
                 takeDamage(100);
             }
        };

        // Boot
        init();

    </script>
</body>
</html>
